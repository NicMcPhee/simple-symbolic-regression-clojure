

# a_script = ":- 64 5 :* :* :* :- :+ :÷ :* :* :+ 2 :÷ :÷ :x :÷ :+ :- :x :÷ 60 26 :- :x :÷ :x :- :- :+ :* 85 :+ :x :- :* :+ :÷ 41 :÷ 60 :÷ 42 51 :÷ :+ :- :x :x :÷ :* :* :* :÷ :* :+ 52 :- :* :÷ :÷ :÷ :+ :+ :- :x 33 :+ :- :* :x :÷ :÷ :+ :* :* :÷ :- 46 :x :x :* :÷ :- :+ :+ :+ :+ 49 :+ 90 :- :x :- :x :x :÷ :* :* :÷ 10 :- :x :* 74 64 :* :* :÷ :÷ 54 :x :x :* :+ 82 :÷ :+ :* :+ :÷ :+ 44 86 :x :* :x :- :÷ :÷ :÷ :÷ 68 :- :* :* :- :- :÷ :÷ :* 26 :- :+ :÷ 95 :x :- :* :+ :* 75 :x :÷ 7 :- :* 93 :+ :* :÷ :+ 78 :÷ :+ 68 :- :* 47 :- :+ :x :x :- 26 :- :÷ :+ :- :x :+ :- :+ :* :+ :- :* :+ :- :* :+ :- :- :x :x :+ :÷ :- :x :* :* 13 :- :* :+ 75 :* :+ :* :x 7 :- :- :- :x :* :x :x :+ :+ :* :* 49 :* 18 :x 48 :x :÷ :÷ :+ :÷ :+ :- :- :÷ :x :÷ :÷ 41 :- :÷ :÷ :* 0 :* :x :+ 37 :x :÷ :- :* :x :- :* :+ :+ 62 :- :- 68 :- :÷ :- :x :+ :+ :* :* :- :* :÷ 10 :÷ :x :- :- :x :* :÷ :÷ :+ 96 :÷ :+ :÷ :x :- 82 :x :+ :÷ 59 :+ :x 92 :* :+ 22 :- :* 74 :x :÷ :- :- :x :- 79 :x :- :* :+ 95 :+ :- :* :x :÷ :+ :- :+ :- :- :- :* :+ :÷ :x :- :÷ :x :* :+ :* :÷ :÷ 6 :- 21 :÷ :x 85 :- :x :* :+ :+ :÷ :÷ :+ :* :÷ :x 39 :÷ :+ :- :- 95 :+ :+ :÷ 63 49 :+ :÷ :+ :x :- :x :- :x 83 :÷ :÷ :x :* :* :÷ :x :+ :x :x :* 56 :÷ :+ :* :* :+ :+ :+ :* :- :÷ :÷ :- :+ :÷ :x :+ 62 :x :- 61 29 :* :- :x :÷ 37 :+ :+ :- :÷ :x 3 :+ :÷ :+ 14 :÷ :- 18 :÷ :x :+ :* :÷ :÷ :* 14 :+ :÷ :x :x :- :÷ 86 :* :x :+ :÷ 98 :x :x :- :* :- :* :x :* :÷ :- :* :÷ :+ :÷ :* :- :* :÷ :* :x 33 35 :- :x :* :- :x :x 74 :- :÷ :- :* :x 67 :- :- :x :- :x :- 31 :÷ :- :+ :÷ :÷ 28 :+ :÷ :- :* :* :* :- :÷ :x :* 5 :x :+ :+ :+ 96 :- :x :x :x 75 :- :- 17 :x :x 14 :+ :x :+ :÷ :- :* :- :- :+ :x :x :* :x :÷ :x :x :÷ :x :x 61 83 :* :* :- :x :+ :* 87 :- 67 :* :* :* :x :- :+ :+ :x :- :÷ :x :* :* 52 :* 3 :- 84 :* 54 :- :+ :* :+ :÷ :÷ :÷ :- :+ 73 :÷ :- 70 :+ :÷ :- 39 :* :÷ :+ :* :* :÷ :- :+ :+ :* :* :- :* 11 :- 78 :÷ :- 68 :x :* :x :- 1 :x :- :* 26 :+ :x :÷ :- :- :- :x :x :* :+ :x :x :- :÷ :+ :- :+ :* :÷ :÷ :÷ :÷ :- 68 41 68 :- :- :+ :* 85 :* 90 :x :x :- :÷ :+ :x :* :- :÷ :÷ :+ :- 39 53 :- :- :÷ 76 78 :÷ :+ :x :- :- :x :- :- :* :x :* 54 :- :÷ :÷ :- :x :- :x :x :* 75 34 :÷ :- :+ :* :- :+ :÷ :- :+ 78 :÷ :+ 68 :- :* :÷ :x :÷ :x :x :* 51 :* :* :÷ :* :x :- :- :x :* :+ :- 35 :+ :x :+ :* :÷ :- :* :- :x 45 :÷ :x :- :÷ :+ :- :- 35 :- :x :* 52 :÷ 96 :x 92 :+ 75 13 :÷ 90 49 :+ :÷ :÷ :÷ :÷ 1 :- 36 :* :÷ :+ :x :x :+ :* :* :x :÷ :÷ 40 :+ :* :x :+ :+ :* :+ 11 :- :÷ :x 2 52 :- :÷ :÷ :÷ :÷ 62 74 72 :÷ :+ :* :* 55 :* :+ 74 :+ :÷ 76 :- :* :+ :x :- :+ 70 :x :x :+ 49 :x :÷ :+ 16 :- 63 :x :÷ 69 :x 66 24 :+ :+ :+ 92 :+ :x :* 50 :x :- :x :x :- :- :* 10 :÷ :+ :- :- 55 :+ :÷ :- :÷ :- 4 :x :x 89 :* :÷ 31 :- 30 60 :÷ :÷ :+ :+ 41 :* :÷ :+ :+ :- :x :- :* :* :- :+ :x :x :+ :x :- 21 22 :- :+ 45 :+ 1 :+ 16 :x :+ :+ :÷ :+ :- :* :+ :+ :+ :x :x :÷ :+ :- :x :÷ :x :* :* :+ 75 :x :+ :- :- :x :x :- :* :÷ :+ 78 :÷ :x 68 :- :- :÷ :- :- :÷ :+ :- 54 80 42 :+ :- :x :- :* :- 55 27 :* :x :- :+ :x :- 68 :- :* :- :+ :x :x :- :x :- :+ :x :+ :x :x :x :* :+ 90 :- :- :÷ :- :÷ :÷ :÷ :÷ :+ :- :- :x 42 :÷ 14 :x :+ :- :- :- :+ :* 99 52 :+ :- :x :* :- :÷ :+ :x :+ :÷ 25 41 :* :- :- :÷ :x :* :* 75 :x :+ 28 :- :* :* :- :* :÷ :+ 78 :÷ :- 68 :- :* :÷ :- :- :x :x :* 26 :- :÷ :÷ :- :+ :- :* 80 :÷ :+ :+ :+ 71 :x :- :* :* :- :* :x :+ :- :+ :+ 31 :÷ :÷ 4 :x 82 :x 47 :* :- :* :x 71 :- :+ :+ 78 :- :- 68 :+ :* :* :+ :+ :x :x :÷ :x :- :* :+ :- :- 51 :+ :÷ :* :÷ :x :+ :* :* :- :+ :x 2 76 :+ 42 :+ :+ :÷ :- :+ :+ 40 52 :+ :x :+ :- 59 :- 54 :÷ :x :x :÷ 23 :- :- :÷ :x 7 :x :+ :* 71 :x 65 :- :÷ :÷ :* :+ :x :+ 7 90 :- :÷ :÷ 83 19 :- :- :* :- :÷ :+ :÷ 78 :÷ :* :* :- :- :- 91 :x :+ :* 15 :- :+ 71 :÷ :- :+ :+ :- :* 85 :* :- :+ :x :÷ :* :+ :+ 10 :- 24 38 :* :x :* 66 :x 48 :+ :- :* 98 51 :÷ :x :- :+ :÷ :* :+ :x :÷ 68 :- :+ :* :+ :+ :÷ 85 :x :* 97 :+ :- :x :+ :÷ :÷ :* :÷ :÷ :- :÷ :+ :x :÷ :÷ :* :x 61 29 :* :- :x :÷ 37 :+ :+ :- :÷ :x :÷ :+ 80 :+ :÷ 6 :- 18 :+ :+ :+ :* :÷ :÷ :+ :+ 34 :- :x :+ :x :- :x :x :÷ 22 :- :* 68 :÷ 27 17 :+ :÷ 73 :÷ 47 :- :÷ :- :- 56 :x :+ 1 :- :* :x :+ :x :÷ :- :* :- 72 91 :+ :÷ :* :* :+ :÷ 20 :+ :x :÷ :* :- :- :- :* :÷ :x :- :+ 16 :÷ :* :+ 39 :- :÷ :x :x :* :+ :x 25 73 89 :* :x :÷ :* :÷ 15 :x 22 :x :x :* 98 :+ 83 :÷ :÷ :- :- :- :- :* :* :* :÷ :÷ 84 :x :+ :+ :- :x :+ :÷ :÷ :- :+ :÷ 27 :* 2 :- :÷ :+ 75 :÷ :* :+ :÷ :+ 67 :÷ :x :* :* 33 :* :÷ 1 :- :x 80 :* :- :- :÷ :x :- :÷ :÷ :x :x :* :- :* :- :+ 45 :x :* :+ :* :* :* :* :* :x :+ :÷ 91 :÷ 97 :x 92 :+ :+ 13 :- :* :- :+ :÷ :* :÷ :* :x :x :x :- :÷ :x :÷ :x :+ :÷ :x :* :- :* 40 :÷ :+ :x :x 48 20 :* :- :- :÷ 3 2 :* :- :x :+ :+ :- :+ 74 :÷ :÷ 44 :- 98 93 :* :- :x :+ :÷ :x 17 :- :÷ :x :- :* :+ :x :x :* :x :* :* :+ 81 :x 63 :x :÷ :x :- 2 70 :+ 4 :+ 92 :+ :+ :x 50 :÷ :+ :x :* :- :- :- :+ :* 61 :÷ :- :x :+ :x :x :x :- :x :* :x :- :* :* :÷ 61 29 :÷ :x :* :x :* :- :- :+ 58 :÷ :- :* :- 10 :+ 55 33 :- 70 :+ :÷ 49 :* 59 :÷ :* :* :÷ :* :* :+ 5 :+ :+ :* :- 3 68 36 :÷ :÷ :- 28 42 :÷ :+ :x :x :- :÷ :÷ :* :* :+ 61 :- :x :* 67 :+ :* :÷ :x :- :- :x :÷ :+ :* :* :* 44 :x :* :- :x :+ :- :- :+ :+ :+ :+ 80 :- :+ :+ :+ :÷ :+ 48 :- :+ :÷ :* :x :+ :+ :* :* :* :* :÷ 55 :÷ 96 :÷ :x :÷ :- :+ :÷ 33 93 :+ :+ 78 :- :+ 68 :÷ :* :÷ :- :+ :* :- :÷ :- :- :+ 22 :+ :x :* :÷ :- :* :x :+ :* :÷ :÷ 96 :- 68 :- :- :* :* :+ :x 26 :÷ :* :* :÷ :+ :* :- :- :÷ :x :* :* :* :x :- :- :x :* :- :- :x :- :- 41 :÷ :x :+ :÷ :+ :*"
# a_script = "13 :+ :swap :+ :* :+ :+ :- :- :* :x :+ :* :* :x :x :* 6 :swap :÷ :x :+ :÷ :- :- :swap :x :÷ :÷ 97 83 :÷ :- :* :+"
# a_script = ":+ :* :x :* :* :- :swap :pop-if-zero :* :pop-if-zero 45 :pop-if-zero :pop-if-positive :pop-if-zero :pop-if-negative :dup :÷ :- 1 :pop-if-zero :- :- :+ :* :pop-if-negative :pop-if-negative :dup :÷ :- 27 :x :pop-if-zero :swap 68 :+ :dup :swap :dup :pop-if-positive 71 23 :pop-if-zero :pop-if-zero :pop-if-negative :÷ :pop-if-negative :pop-if-zero :pop-if-zero :* :pop-if-positive :x :pop-if-negative :- :+ :÷ :pop-if-negative :x 17 :pop-if-negative :dup :+ :dup 48 :pop-if-positive :pop-if-negative :dup 13 :- :x :* :x :+ :- :+ 80 :÷"
a_script = ":pop-if-negative :- :- 23 :- 85 :x :pop-if-negative :swap :pop-if-zero :÷ :pop-if-positive :pop-if-positive :dup :dup :pop-if-positive :- :÷ :pop-if-positive :x :dup :dup :÷ :pop-if-zero 88 :swap :pop-if-zero :x :+ :+ :swap :dup 63 :dup :- :x 95 :pop-if-zero :x :swap :pop-if-positive :pop-if-positive :x 44 :÷ :pop-if-negative :- :+ :swap :+ :+ :pop-if-positive 1 24 :x :pop-if-positive :* :x :pop-if-zero :pop-if-positive :pop-if-zero :pop-if-positive :pop-if-zero :+ :+ :dup :pop-if-zero :pop-if-negative :÷ :+ :pop-if-negative :* 89 :÷ :+ :pop-if-positive 51 :- :- :÷ :dup :+ :pop-if-zero :÷ :pop-if-positive :dup :dup :swap 90 :pop-if-zero :pop-if-positive :pop-if-positive :- :pop-if-negative :pop-if-positive :pop-if-zero :pop-if-zero :- :dup :÷ :pop-if-negative :pop-if-negative :+ :dup :swap :* :x :- :- :swap :pop-if-negative 80 91 :x :+ :dup :pop-if-negative 90 :÷ :pop-if-negative :- :x :pop-if-negative :pop-if-negative :pop-if-positive :swap :swap :dup :- :- :pop-if-zero 67 :pop-if-positive :+ :÷ :- :swap :swap :* :dup :dup 13 :dup :x :+ :pop-if-positive :* :* :x :+ :pop-if-negative :x :dup :swap :pop-if-zero :÷ :÷ :pop-if-positive :pop-if-positive :dup :dup :+ :* :+ 85 :pop-if-positive :swap :dup :pop-if-zero 30 :÷ :÷ :* :pop-if-zero :pop-if-negative :pop-if-zero :÷ :swap :÷ :x :÷ :- :pop-if-zero :x 4 :pop-if-negative :dup :pop-if-positive :swap :pop-if-zero :dup :swap :dup :* :swap :swap 25 67 :swap :* :x :pop-if-positive :pop-if-zero :x :pop-if-negative :pop-if-negative :÷ :dup :pop-if-negative :÷ :* :swap :pop-if-positive :÷ :pop-if-positive :- :pop-if-negative :pop-if-positive :+ :÷ :* :dup :* :+ 70 :swap :swap :x :÷ :* :swap :+ :- :swap :* :x 6 41 :swap :x :+ :÷ :x :* :swap :pop-if-zero :dup 71 23 :+ :pop-if-zero 47 :dup :- :pop-if-negative :+ :* :pop-if-positive :- :pop-if-negative :- :* :- :pop-if-negative :x :+ :pop-if-negative :dup :* :+ :* :- :pop-if-negative :dup 13 :pop-if-zero :swap :swap :pop-if-zero :dup :x :dup :pop-if-zero :- :* :dup :pop-if-positive :pop-if-negative :* :* :pop-if-positive 11 :x 3 :- :swap :x :* :* :swap :pop-if-zero :- :dup :pop-if-zero :x :swap :- 42 :- :÷"


def run_this(script,x)
  stack = []
  wtf_stack = []

  tokens = script.split(/\s/)
  tokens.each do |token|
    # puts wtf_stack.inspect
    case token
    when /\d+/
      stack.push token.to_f
      wtf_stack.push token
    when /:\+/
      if stack.length > 1
        arg1,arg2 = stack.pop(2)
        stack.push(arg1+arg2)

        wtf1,wtf2 = wtf_stack.pop(2)
        wtf_stack.push "(#{wtf1}+#{wtf2})"
      end
    when /:\-/
      if stack.length > 1
        arg1,arg2 = stack.pop(2)
        stack.push(arg1-arg2)

        wtf1,wtf2 = wtf_stack.pop(2)
        wtf_stack.push "(#{wtf1}-#{wtf2})"
      end
    when /:\*/
      if stack.length > 1
        arg1,arg2 = stack.pop(2)
        stack.push(arg1*arg2)

        wtf1,wtf2 = wtf_stack.pop(2)
        wtf_stack.push "(#{wtf1}*#{wtf2})"
      end
    when /:\÷/
      if stack.length > 1
        arg1,arg2 = stack.pop(2)
        if (arg2 != 0)
          stack.push(arg1/arg2)

          wtf1,wtf2 = wtf_stack.pop(2)
          wtf_stack.push "(#{wtf1}/#{wtf2})"
        else
          stack.push(arg1,arg2) # we do not consume arguments if it would lead to div0
        end
      end
    when /:swap/
      if stack.length > 1
          arg1, arg2 = stack.pop(2)
          stack.push(arg2)
          stack.push(arg1)

          wtf1, wtf2 = wtf_stack.pop(2)
          wtf_stack.push(wtf2)
          wtf_stack.push(wtf1)
      end
    when /:dup/
      if stack.length > 0
          arg = stack.pop
          stack.push(arg)
          stack.push(arg)

          wtf = wtf_stack.pop
          wtf_stack.push(wtf)
          wtf_stack.push(wtf)
      end
    when /:pop-if-zero/
      if stack.length > 0
        arg = stack.pop
        wtf = wtf_stack.pop
        if arg != 0
          stack.push(arg)
          wtf_stack.push(wtf)
        end
      end
    when /:pop-if-positive/
      if stack.length > 0
        arg = stack.pop
        wtf = wtf_stack.pop
        if arg <= 0
          stack.push(arg)
          wtf_stack.push(wtf)
        end
      end
    when /:pop-if-negative/
      if stack.length > 0
        arg = stack.pop
        wtf = wtf_stack.pop
        if arg >= 0
          stack.push(arg)
          wtf_stack.push(wtf)
        end
      end
    when /:x/
      stack.push(x.to_f)
      wtf_stack.push "x"
    else
        puts "that's not right!, token = " + token
    end
  end
  return {:stack => stack, :wtf => wtf_stack}
end


try_me = run_this(a_script,0.0)
puts try_me[:stack].inspect
puts "About to print WTF"
puts try_me[:wtf].inspect



def print_comparison_table(script)
  range = 2 * (Math.const_get :PI)
  total_error = 0.0
  (0..32).each do |i|
    x = range*i/32.0
    result = run_this(script,x)[:stack][-1]
    err = (Math.sin(x) - result).abs
    total_error += (Math.sin(x) - result).abs
    puts "#{x},#{Math.sin(x)},#{result},#{err},#{total_error}"
  end
end

print_comparison_table(a_script)

